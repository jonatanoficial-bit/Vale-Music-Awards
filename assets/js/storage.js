const VP_STORE_KEYS={reg:"vp_registrations_v1",scores:"vp_scores_v1",judge:"vp_judge_session_v1",candSession:"vp_candidate_session_v1"};function vpReadJSON(k,f){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch(e){return f}}function vpWriteJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}async function vpLoadCandidates(){const isSub=location.pathname.includes("/pages/");const basePath=isSub?"../data/candidates.json":"./data/candidates.json";const base=await fetch(basePath).then(r=>r.json()).catch(()=>[]);const regs=vpReadJSON(VP_STORE_KEYS.reg,[]);return [...base,...regs]}function vpGetScores(){return vpReadJSON(VP_STORE_KEYS.scores,{})}function vpSetScores(s){vpWriteJSON(VP_STORE_KEYS.scores,s)}function vpWeightedScore(s){const w=window.VP_CONFIG.weights;const voz=Number(s?.voz??0),af=Number(s?.afinacao??0),i=Number(s?.interpretacao??0);return Math.round(((voz*w.voz)+(af*w.afinacao)+(i*w.interpretacao))*100)/100}function vpUpsertScore(id,user,p){const s=vpGetScores();s[id]=s[id]||{byJudge:{},updatedAt:null};s[id].byJudge[user]={...s[id].byJudge[user],...p,at:new Date().toISOString()};s[id].updatedAt=new Date().toISOString();vpSetScores(s);return s}function vpAggregate(id){const s=vpGetScores();const e=s[id];if(!e||!e.byJudge)return null;const judges=Object.values(e.byJudge);if(!judges.length)return null;const avg=k=>judges.reduce((a,j)=>a+Number(j[k]??0),0)/judges.length;const a={voz:avg("voz"),afinacao:avg("afinacao"),interpretacao:avg("interpretacao"),note:judges.map(j=>j.note).filter(Boolean).slice(-1)[0]||"",judgesCount:judges.length,updatedAt:e.updatedAt};a.weighted=vpWeightedScore(a);return a}function vpNextCandidateCode(){const regs=vpReadJSON(VP_STORE_KEYS.reg,[]);const cfg=window.VP_CONFIG.candidateCode;const max=regs.reduce((m,r)=>{const n=Number(String(r.id||"").split("-")[1]||0);return Math.max(m,n)},cfg.startAt);return `${cfg.prefix}-${max+1}`}function vpResetDemo(){localStorage.removeItem(VP_STORE_KEYS.scores);localStorage.removeItem(VP_STORE_KEYS.judge);}