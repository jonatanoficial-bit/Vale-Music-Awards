<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking • Vale Music Awards</title>

  <link rel="icon" href="../assets/img/favicon.png" />
  <link rel="stylesheet" href="../assets/css/style.css" />

  <!-- Config central (mantém como está) -->
  <script src="../assets/js/vma-config.js"></script>

  <style>
    /* Ajuste visual do avatar no ranking (premium + consistente) */
    .rankAvatar {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      overflow: hidden;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
      flex: 0 0 auto;
    }

    .rankAvatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.05) contrast(1.02);
    }

    .rankAvatar .fallback {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      color: rgba(255,255,255,0.92);
      background: radial-gradient(circle at 30% 20%, rgba(212,175,55,0.35), rgba(0,0,0,0.25) 55%),
                  linear-gradient(135deg, rgba(255,255,255,0.06), rgba(0,0,0,0.25));
    }

    /* Segurança: garante que o item não “quebre layout” */
    .rankRow {
      display: flex;
      align-items: center;
      gap: 12px;
    }
  </style>
</head>

<body class="appBody">
  <header class="topbar">
    <div class="brand">
      <img src="../assets/img/vale-producao-logo.png" alt="Vale Produção" class="brandLogo" />
      <div class="brandText">
        <div class="brandTitle">Vale Music Awards</div>
        <div class="brandSub">Ranking Oficial • Atualização ao vivo</div>
      </div>
    </div>

    <nav class="navPills">
      <a class="pill" href="../index.html">Início</a>
      <a class="pill" href="./inscricao.html">Inscrição</a>
      <a class="pill pillGold" href="./jurados.html">Área de jurados</a>
    </nav>
  </header>

  <main class="container">
    <section class="heroCard">
      <h1 class="heroTitle">Ranking ao vivo</h1>
      <p class="heroDesc">
        O ranking é calculado a partir da <strong>média das notas (0–100)</strong> registradas pelos jurados.
        A atualização ocorre automaticamente após cada avaliação confirmada.
      </p>

      <div class="heroActions">
        <div class="chip chipOnline">
          <span class="dot"></span>
          <span>Online</span>
        </div>

        <button id="btnRefresh" class="btn btnPrimary">Atualizar</button>
      </div>

      <div id="statusBox" class="statusBox">
        <span id="statusText">Pronto para carregar ranking...</span>
        <div class="statusMeta" id="updatedText"></div>
      </div>
    </section>

    <section class="listWrap">
      <div id="rankingList" class="rankingList"></div>
    </section>

    <footer class="footer">
      Criado por Jonatan Vale em parceria com Vale Produção.
    </footer>
  </main>

  <script>
    (function () {
      "use strict";

      const listEl = document.getElementById("rankingList");
      const btn = document.getElementById("btnRefresh");
      const statusText = document.getElementById("statusText");
      const updatedText = document.getElementById("updatedText");

      function nowBR() {
        try { return new Date().toLocaleString("pt-BR"); } catch { return String(new Date()); }
      }

      function setStatus(msg) {
        statusText.textContent = msg;
        updatedText.textContent = "Atualizado: " + nowBR();
      }

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function initials(name) {
        const n = String(name || "").trim();
        if (!n) return "VA";
        const parts = n.split(/\s+/).filter(Boolean);
        const a = (parts[0] || "").slice(0, 1);
        const b = (parts.length > 1 ? parts[parts.length - 1] : parts[0]).slice(0, 1);
        return (a + b).toUpperCase();
      }

      // ✅ MESMA LÓGICA DO JURADOS (gerar imagem a partir do ID do Drive)
      function extractDriveId(url) {
        const u = String(url || "");
        // uc?...id=FILEID
        let m = u.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
        if (m && m[1]) return m[1];
        // /file/d/FILEID
        m = u.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/);
        if (m && m[1]) return m[1];
        return "";
      }

      // Gera URL que renderiza em <img> (thumbnail)
      function driveThumbFromAny(url) {
        const id = extractDriveId(url);
        if (!id) return "";
        return "https://drive.google.com/thumbnail?id=" + id + "&sz=w300";
      }

      function normalizeScore(n) {
        const v = Number(n);
        if (!Number.isFinite(v)) return 0;
        return Math.max(0, Math.min(100, v));
      }

      function renderRanking(items) {
        if (!Array.isArray(items) || items.length === 0) {
          listEl.innerHTML = "";
          setStatus("Nenhum candidato no ranking ainda.");
          return;
        }

        const html = items.map(function (c) {
          const pos = Number(c.position || 0) || 0;
          const cid = esc(c.candidateId || "");
          const nameRaw = c.artisticName || c.name || "Candidato";
          const name = esc(nameRaw);
          const score = normalizeScore(c.avgScore100);
          const scoreText = score.toFixed(2);
          const count = Number(c.scoresCount || 0) || 0;

          // prioridade: se vier "photoThumbUrl" do backend (futuro), usa.
          // senão converte o que já existe (photoUrl/photoPublicUrl) pra thumbnail
          const srcRaw =
            (c.photoThumbUrl || "") ||
            (c.photoViewUrl || "") ||
            (c.photoUrl || "") ||
            (c.photoPublicUrl || "");

          const photo = driveThumbFromAny(srcRaw);

          const ini = esc(initials(nameRaw));

          return `
            <div class="rankCard">
              <div class="rankLeft">
                <div class="rankPos">${pos}</div>

                <div class="rankRow">
                  <div class="rankAvatar">
                    ${
                      photo
                        ? `<img src="${esc(photo)}"
                               alt="Foto de ${name}"
                               loading="lazy"
                               referrerpolicy="no-referrer"
                               onerror="this.parentNode.innerHTML='<div class=\\'fallback\\'>${ini}</div>';">`
                        : `<div class="fallback">${ini}</div>`
                    }
                  </div>

                  <div class="rankInfo">
                    <div class="rankName">${name}</div>
                    <div class="rankMeta">
                      <span class="tag">ID: ${cid}</span>
                      <span class="tag">${count} avaliação(ões)</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="rankScore">
                <div class="rankScoreNum">${scoreText}</div>
                <div class="rankScoreSub">/100</div>
              </div>
            </div>
          `;
        }).join("");

        listEl.innerHTML = html;
        setStatus("✅ Ranking carregado • " + items.length + " candidato(s)");
      }

      async function loadRanking() {
        const cfg = window.VMA_CONFIG || {};
        const base = String(cfg.APPS_SCRIPT_URL || "").trim().replace(/\/$/, "");
        if (!base) {
          setStatus("Erro: Config não carregou (vma-config.js).");
          return;
        }

        setStatus("Carregando ranking...");
        try {
          const url = base + "?action=ranking&t=" + Date.now();
          const res = await fetch(url);
          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          if (!data || data.ok !== true) {
            throw new Error((data && data.error) ? data.error : "Resposta inválida do Apps Script");
          }

          renderRanking(Array.isArray(data.ranking) ? data.ranking : []);
        } catch (e) {
          console.error(e);
          listEl.innerHTML = "";
          setStatus("❌ Erro ao carregar ranking: " + (e && e.message ? e.message : e));
        }
      }

      btn.addEventListener("click", loadRanking);
      loadRanking();
    })();
  </script>
</body>
</html>